<!doctype html>
<html lang="en" class="h-full" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Sells & Prefunds DB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      :root {
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
        --input-bg: #ffffff;
        --input-border: #d1d5db;
        --input-text: #111827;
        --input-placeholder: #9ca3af;
      }
      html.dark {
        --card-bg: #1f2937;      /* gray-800 */
        --card-border: #374151;  /* gray-700 */
        --input-bg: #111827;     /* gray-900 */
        --input-border: #374151; /* gray-700 */
        --input-text: #e5e7eb;   /* gray-200 */
        --input-placeholder: #9ca3af;
      }
      .login-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0,0,0,.12);
        padding: 2rem;
        width: 100%;
        max-width: 28rem;
      }
      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        background: var(--input-bg);
        color: var(--input-text);
        border: 1px solid var(--input-border);
        transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease, color .2s ease;
      }
      .form-input::placeholder { color: var(--input-placeholder); }
      .form-input:focus { outline: none; border-color: #0284c7; box-shadow: 0 0 0 3px rgb(2 132 199 / 0.25); }
      .btn-primary[disabled] { opacity: .7; cursor: not-allowed; }
    </style>
  </head>
  <body class="h-full bg-gradient-to-br from-sky-50 to-blue-100 dark:from-gray-900 dark:to-gray-800">
    <div class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="w-full max-w-md space-y-8">
        <!-- Header -->
        <div class="text-center">
          <div class="mx-auto w-16 h-16 rounded-2xl bg-sky-600 flex items-center justify-center mb-4">
            <i class="fas fa-database text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white" data-i18n="app_title">Sells & Prefunds DB</h1>
          <p class="mt-2 text-gray-600 dark:text-gray-400"><span data-i18n="sign_in_title">Please sign in to continue</span></p>
        </div>

        <!-- Card -->
        <form id="login-form" class="login-card mt-6 space-y-6" novalidate>
          <!-- Dark mode + brand -->
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-500 dark:text-gray-400">
              <span class="font-medium"><span data-i18n="welcome_back">Welcome back</span></span>
            </div>
            <button type="button" id="theme-toggle" class="inline-flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
              <i class="fa-solid fa-moon hidden dark:inline"></i>
              <i class="fa-regular fa-sun dark:hidden"></i>
              <span class="hidden sm:inline"><span data-i18n="toggle_theme">Toggle theme</span></span>
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="username">Username</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-user text-gray-400"></i>
                </div>
                <input
                  id="username"
                  name="username"
                  type="text"
                  autocomplete="username"
                  required
                  class="form-input pl-10"
                  data-i18n="username" data-i18n-attr="placeholder" placeholder="yourname"
                  aria-invalid="false"
                />
              </div>
            </div>

            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="change_password">Password</label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-lock text-gray-400"></i>
                </div>
                <input
                  id="password"
                  name="password"
                  type="password"
                  autocomplete="current-password"
                  required
                  class="form-input pl-10 pr-10"
                  placeholder="Your password"
                  aria-invalid="false"
                />
                <button
                  type="button"
                  id="toggle-pass"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
                  aria-label="Show password">
                  <i class="fa-regular fa-eye" id="eye-open"></i>
                  <i class="fa-regular fa-eye-slash hidden" id="eye-closed"></i>
                </button>
              </div>
            </div>

            <p id="form-error" class="hidden text-sm text-red-600"></p>
          </div>

          <div class="flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300 cursor-pointer select-none">
              <input id="remember" type="checkbox" class="rounded border-gray-300 text-sky-600 focus:ring-sky-500">
              <span data-i18n="remember_me">Remember me</span>
            </label>
            <a href="#" class="text-sm text-sky-700 hover:text-sky-800 dark:text-sky-400 dark:hover:text-sky-300"><span data-i18n="forgot_password">Forgot password?</span></a>
          </div>

          <button
            type="submit"
            class="btn-primary group relative w-full flex justify-center items-center gap-2 py-3 px-4 rounded-lg bg-sky-600 hover:bg-sky-700 focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 text-white font-medium transition"
          >
            <i class="fas fa-sign-in-alt"></i>
            <span><span data-i18n="sign_in">Sign in</span>
          </button>

          <div class="text-center pt-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-sm text-gray-500 dark:text-gray-400">
              Default admin:
              <span class="font-medium">admin</span> /
              <span class="font-medium">Admin123!</span>
            </p>
          </div>
        </form>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <script type="module">
      import { api } from './js/api.js';
      import { showToast } from './js/ui.js';
      import { applyTranslations, setLang, t } from './js/i18n.js';

      // Initialize language selector
      (function(){
        try {
          const header = document.querySelector('.text-center');
          if (header && !document.getElementById('lang-select')) {
            const langSel = document.createElement('select');
            langSel.id = 'lang-select';
            langSel.className = 'form-input w-auto py-1 px-2 text-sm mb-3';
            langSel.innerHTML = '<option value="en">EN</option><option value="fa">دری</option>';
            header.appendChild(langSel);
            langSel.value = localStorage.getItem('lang') || 'en';
            langSel.addEventListener('change', () => setLang(langSel.value));
          }
          applyTranslations();
        } catch {}
      })();

      const form = document.getElementById('login-form');
      const formError = document.getElementById('form-error');
      const submitBtn = form.querySelector('button[type="submit"]');
      const usernameEl = document.getElementById('username');
      const passwordEl = document.getElementById('password');

      // Basic client-side validation
      function validate() {
        formError.classList.add('hidden');
        usernameEl.setAttribute('aria-invalid', 'false');
        passwordEl.setAttribute('aria-invalid', 'false');

        if (!usernameEl.value.trim()) {
          formError.textContent = t('username_required');
          formError.classList.remove('hidden');
          usernameEl.setAttribute('aria-invalid', 'true');
          usernameEl.focus();
          return false;
        }
        if (!passwordEl.value) {
          formError.textContent = t('password_required');
          formError.classList.remove('hidden');
          passwordEl.setAttribute('aria-invalid', 'true');
          passwordEl.focus();
          return false;
        }
        return true;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validate()) return;

        const originalHTML = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span> ' + t('signing_in') + '</span>';
        submitBtn.disabled = true;

        const username = usernameEl.value.trim();
        const password = passwordEl.value;
        const remember = document.getElementById('remember').checked;

        try {
          await api.post('/api/auth/login', { username, password, remember });
          showToast(t('signed_in_success'), 'success');
          window.location.href = '/';
        } catch (err) {
          const msg = err?.message || t('login_failed');
          formError.textContent = msg;
          formError.classList.remove('hidden');
          showToast(msg, 'error');
          submitBtn.innerHTML = originalHTML;
          submitBtn.disabled = false;
        }
      });

      // Password visibility toggle
      const togglePass = document.getElementById('toggle-pass');
      const eyeOpen = document.getElementById('eye-open');
      const eyeClosed = document.getElementById('eye-closed');
      togglePass.addEventListener('click', () => {
        const isHidden = passwordEl.type === 'password';
        passwordEl.type = isHidden ? 'text' : 'password';
        eyeOpen.classList.toggle('hidden', isHidden);
        eyeClosed.classList.toggle('hidden', !isHidden);
        togglePass.setAttribute('aria-label', isHidden ? t('hide_password') : t('show_password'));
      });

      // Submit on Enter key anywhere in form
      form.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (document.activeElement === usernameEl || document.activeElement === passwordEl)) {
          form.requestSubmit();
        }
      });

      // Theme init & toggle
      const themeToggle = document.getElementById('theme-toggle');
      const applyTheme = (t) => {
        document.documentElement.classList.toggle('dark', t === 'dark');
        localStorage.setItem('theme', t);
      };
      const savedTheme = localStorage.getItem('theme');
      applyTheme(savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
      themeToggle.addEventListener('click', () => {
        const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(next);
      });
    </script>
  </body>
</html>
